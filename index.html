<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Value Stream Map Visualizer</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Value Stream Map Visualizer</h1>
            <p>Define your processes and flows using our DSL, then visualize your value stream map</p>
        </div>
        
        <div class="main-content">
            <div class="editor-panel">
                <div class="panel-header">
                    <h3 class="panel-title">DSL Editor</h3>
                    <div class="button-group">
                        <button class="editor-button" onclick="window.saveVSM()">Save VSM</button>
                        <button class="parse-button" onclick="window.parseAndVisualize()">Generate VSM</button>
                    </div>
                </div>
                <textarea id="dslEditor" class="editor" placeholder="Enter your VSM DSL here...">process stamping {
  stage_id: 1
  name: "Sheet Metal Stamping"
  owner: "Manufacturing Team A"
  description: "High-pressure stamping of steel sheets"
  lead_time: 3.2d
  cycle_time: 45s
  process_time: 40s
  batch_size: 100
  defect_rate: 2.5
}

process welding {
  stage_id: 2
  name: "Spot Welding Assembly"
  owner: "Welding Department"
  description: "Robotic spot welding of stamped components"
  lead_time: 1.8d
  cycle_time: 60s
  process_time: 55s
  batch_size: 50
  defect_rate: 1.2
}

process photography {
  stage_id: 3
  name: "Quality Photography"
  owner: "QC Documentation Team"
  description: "Digital photography for quality records"
  lead_time: 1.2d
  cycle_time: 30s
  process_time: 25s
  batch_size: 100
  defect_rate: 0.5
}

process assembly {
  stage_id: 4
  name: "Final Door Assembly"
  owner: "Assembly Line Team"
  description: "Installation of hinges, handles, weather stripping"
  lead_time: 2.5d
  cycle_time: 90s
  process_time: 85s
  batch_size: 25
  defect_rate: 3.1
}

flow from stamping to welding {
  wait_time: 0.5d
}

flow from stamping to photography {
  wait_time: 0.3d
}

flow from welding to assembly {
  wait_time: 1.8d
}

flow from photography to assembly {
  wait_time: 2.1d
}</textarea>
            </div>
            
            <div class="visualization-panel">
                <div class="panel-header">
                    <h3 class="panel-title">Value Stream Map</h3>
                </div>
                <div class="canvas-container">
                    <svg id="vsmCanvas" width="900" height="700"></svg>
                </div>
            </div>
        </div>

        <div class="totals-strip">
            <div class="total-item">
                <div class="total-label">Total Lead Time</div>
                <div class="total-value" id="totalLeadTime">-</div>
            </div>
            <div class="total-item">
                <div class="total-label">Total Wait Time</div>
                <div class="total-value" id="totalWaitTime">-</div>
            </div>
            <div class="total-item">
                <div class="total-label">Total Process Time</div>
                <div class="total-value" id="totalProcessTime">-</div>
            </div>
            <div class="total-item">
                <div class="total-label">Critical Path</div>
                <div class="critical-path" id="criticalPath">-</div>
            </div>
        </div>
    </div>

    <script type="module">
        import VSMParser from './js/VSMParser.js';
        import VSMVisualizer from './js/VSMVisualizer.js';

        const parser = new VSMParser();
        let visualizer;

        function initializeVSM() {
            visualizer = new VSMVisualizer(document.getElementById('vsmCanvas'));
            
            // Try to load saved state from localStorage
            const savedState = localStorage.getItem('vsmState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    visualizer.visualize(state);
                } catch (e) {
                    console.error('Error loading saved state:', e);
                    // Fall back to parsing current DSL
                    parseAndVisualize();
                }
            } else {
                // No saved state, parse current DSL
                parseAndVisualize();
            }

            // Add DSL editor change listener with debounce
            let dslTimeout;
            document.getElementById('dslEditor').addEventListener('input', () => {
                clearTimeout(dslTimeout);
                dslTimeout = setTimeout(() => {
                    visualizer.parseDSLChanges();
                }, 500); // Wait 500ms after typing stops
            });
        }

        function saveVSM() {
            if (visualizer) {
                visualizer.saveState();
                // Show feedback to user
                const feedback = document.createElement('div');
                feedback.textContent = 'VSM saved successfully';
                feedback.style.position = 'fixed';
                feedback.style.top = '20px';
                feedback.style.right = '20px';
                feedback.style.background = '#2ecc71';
                feedback.style.color = 'white';
                feedback.style.padding = '10px 20px';
                feedback.style.borderRadius = '4px';
                feedback.style.opacity = '0';
                feedback.style.transition = 'opacity 0.3s';
                
                document.body.appendChild(feedback);
                setTimeout(() => feedback.style.opacity = '1', 10);
                setTimeout(() => {
                    feedback.style.opacity = '0';
                    setTimeout(() => document.body.removeChild(feedback), 300);
                }, 2000);
            }
        }

        function parseAndVisualize() {
            const dslText = document.getElementById('dslEditor').value;
            try {
                const parsedData = parser.parse(dslText);
                visualizer.visualize(parsedData);
            } catch (error) {
                console.error('Parse error:', error);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = `Parse Error: ${error.message}`;
                
                const canvasContainer = document.querySelector('.canvas-container');
                const existingError = document.querySelector('.error');
                if (existingError) {
                    existingError.remove();
                }
                canvasContainer.insertBefore(errorDiv, document.getElementById('vsmCanvas'));
            }
        }

        // Make functions available globally
        window.parser = parser;
        window.saveVSM = saveVSM;
        window.parseAndVisualize = parseAndVisualize;

        // Initialize on page load
        initializeVSM();
    </script>
</body>
</html>