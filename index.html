<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Value Stream Map Visualizer</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Value Stream Map Visualizer</h1>
            <p>Define your processes and flows using our DSL, then visualize your value stream map</p>
        </div>
        
        <div class="main-content">
            <div class="editor-panel collapsed">
                <button class="editor-toggle" title="Toggle DSL Editor">⟩</button>
                <div class="panel-header">
                    <div class="button-group">
                        <button class="editor-button" data-action="clear">New VSM</button>
                    </div>
                </div>
                <textarea id="dslEditor" class="editor" spellcheck="false">process stamping {
  stage_id: 1
  name: "Sheet Metal Stamping"
  owner: "Manufacturing Team A"
  description: "High-pressure stamping of steel sheets"
  wait_time: 3.2d
  process_time: 40s
  defect_rate: 2.5
}

process welding {
  stage_id: 2
  name: "Spot Welding Assembly"
  owner: "Welding Department"
  description: "Robotic spot welding of stamped components"
  wait_time: 1.8d
  process_time: 55s
  defect_rate: 1.2
}

process photography {
  stage_id: 3
  name: "Quality Photography"
  owner: "QC Documentation Team"
  description: "Digital photography for quality records"
  wait_time: 1.2d
  process_time: 25s
  defect_rate: 0.5
}

process assembly {
  stage_id: 4
  name: "Final Door Assembly"
  owner: "Assembly Line Team"
  description: "Installation of hinges, handles, weather stripping"
  wait_time: 2.5d
  process_time: 85s
  defect_rate: 3.1
}

flow from stamping to welding {
  wait_time: 0.5d
}

flow from stamping to photography {
  wait_time: 0.3d
}

flow from welding to assembly {
  wait_time: 1.8d
}

flow from photography to assembly {
  wait_time: 2.1d
}</textarea>
                <button class="parse-button" onclick="parseAndVisualize()">Parse & Visualize</button>
            </div>
            <div class="pane-splitter" id="paneSplitter"></div>
            <div class="visualization-panel">
                <div class="canvas-container">
                    <svg id="vsmCanvas" width="900" height="700"></svg>
                </div>
            </div>
        </div>

        <div class="totals-strip">
            <div class="total-item">
                <div class="total-label">Total Lead Time</div>
                <div class="total-value" id="totalLeadTime">-</div>
            </div>
            <div class="total-item">
                <div class="total-label">Total Wait Time</div>
                <div class="total-value" id="totalWaitTime">-</div>
            </div>
            <div class="total-item">
                <div class="total-label">Total Process Time</div>
                <div class="total-value" id="totalProcessTime">-</div>
            </div>
            <div class="total-item">
                <div class="total-label">Critical Path</div>
                <div class="critical-path" id="criticalPath">-</div>
            </div>
        </div>
    </div>

    <script type="module">
        import VSMParser from './js/VSMParser.js';
        import VSMVisualizer from './js/VSMVisualizer.js';

        const parser = new VSMParser();
        let visualizer;

        function clearVSM() {
            const processId = `process_${Date.now()}`;

            // Create default DSL with one process
            const defaultDSL = `process ${processId} {
  stage_id: 1
  name: "New Process"
  owner: ""
  description: "New process description"
  wait_time: 0d
  process_time: 0s
  defect_rate: 0
}`;

            // Set the DSL editor
            document.getElementById('dslEditor').value = defaultDSL;

            // Create the default process structure
            const defaultProcess = {
                attributes: {
                    stage_id: 1,
                    name: "New Process",
                    owner: "",
                    description: "New process description",
                    wait_time: "0d",
                    process_time: "0s",
                    defect_rate: "0"
                }
            };

            // Reset the visualizer data with the default process
            visualizer.currentProcesses = { [processId]: defaultProcess };
            visualizer.currentFlows = [];
            visualizer.currentInfoFlows = [];

            // Position the process in the center
            const centerX = visualizer.width / 2 - visualizer.processWidth / 2;
            const centerY = visualizer.height / 2 - visualizer.processHeight / 2;
            visualizer.positions = { [processId]: { x: centerX, y: centerY } };

            // Visualize with the default process
            visualizer.visualize({
                processes: visualizer.currentProcesses,
                flows: [],
                infoFlows: [],
                positions: visualizer.positions
            });
        }

        async function initializeVSM() {
            visualizer = new VSMVisualizer(document.getElementById('vsmCanvas'));
            
            // Try to load saved state first
            if (!visualizer.loadState()) {
                // If no saved state, load initial DSL
                const initialData = parser.loadInitialDSL();
                visualizer.visualize(initialData);
            }

            // Setup editor panel toggle
            const editorPanel = document.querySelector('.editor-panel');
            const toggleButton = document.querySelector('.editor-toggle');
            
            if (toggleButton) {
                toggleButton.addEventListener('click', () => {
                    editorPanel.classList.toggle('collapsed');
                    toggleButton.textContent = editorPanel.classList.contains('collapsed') ? '⟩' : '⟨';
                });
            }

            // Add button click handlers
            document.querySelector('[data-action="clear"]').addEventListener('click', clearVSM);
        }

        function parseAndVisualize() {
            const dslText = document.getElementById('dslEditor').value;
            const parsedData = parser.parse(dslText);
            
            // No time validation needed since CT is calculated as PT + WT
            
            // If validation passes, update visualization
            visualizer.visualize(parsedData);
        }

        function saveVSM() {
            if (visualizer) {
                visualizer.saveState();
            }
        }

        function addNewProcess() {
            const processId = `process_${Date.now()}`;
            const newProcess = {
                attributes: {
                    stage_id: 1,
                    name: "New Process",
                    owner: "",
                    description: "New process description",
                    wait_time: "0d",
                    process_time: "0s",
                    defect_rate: "0"
                }
            };

            // Add to current processes
            visualizer.currentProcesses[processId] = newProcess;

            // Calculate position for new process
            const centerX = visualizer.width / 2 - visualizer.processWidth / 2;
            const centerY = visualizer.height / 2 - visualizer.processHeight / 2;
            visualizer.positions[processId] = { x: centerX, y: centerY };

            // Update the DSL text
            const dslEditor = document.getElementById('dslEditor');
            const processBlock = `\nprocess ${processId} {
  stage_id: 1
  name: "New Process"
  owner: ""
  description: "New process description"
  wait_time: 0d
  process_time: 0s
  defect_rate: 0
}\n`;
            
            dslEditor.value += processBlock;

            // Redraw the visualization
            visualizer.visualize({
                processes: visualizer.currentProcesses,
                flows: visualizer.currentFlows,
                infoFlows: visualizer.currentInfoFlows,
                positions: visualizer.positions
            });
        }

        // Make functions globally available
        window.parser = parser;
        window.saveVSM = saveVSM;
        window.parseAndVisualize = parseAndVisualize;
        window.addNewProcess = addNewProcess;

        // Initialize pane splitter
        function initializePaneSplitter() {
            const splitter = document.getElementById('paneSplitter');
            const editorPanel = document.querySelector('.editor-panel');
            const mainContent = document.querySelector('.main-content');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            splitter.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = editorPanel.offsetWidth;
                splitter.classList.add('active');
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'col-resize';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const deltaX = e.clientX - startX;
                const newWidth = Math.max(200, Math.min(startWidth + deltaX, mainContent.offsetWidth * 0.8));
                editorPanel.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    splitter.classList.remove('active');
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                }
            });
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeVSM();
                initializePaneSplitter();
            });
        } else {
            initializeVSM();
            initializePaneSplitter();
        }
    </script>
</body>
</html>