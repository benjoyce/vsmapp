<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Value Stream Map Visualizer</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Value Stream Map Visualizer</h1>
            <p>Define your processes and flows using our DSL, then visualize your value stream map</p>
        </div>
        
        <div class="main-content">
            <div class="editor-panel collapsed">
                <button class="editor-toggle" title="Toggle DSL Editor">⟩</button>
                <div class="panel-header">
                    <div class="filename-display" id="currentFilename">
                        <span class="filename-label">File:</span>
                        <span class="filename-text">Untitled.vsm</span>
                    </div>
                    <div class="button-group">
                        <button class="editor-button" data-action="save-file">Save File</button>
                        <button class="editor-button" data-action="load-file">Load File</button>
                        <button class="editor-button" data-action="clear">New VSM</button>
                    </div>
                </div>
                <textarea id="dslEditor" class="editor" spellcheck="false">process stamping {
  stage_id: 1
  name: "Sheet Metal Stamping"
  owner: "Manufacturing Team A"
  description: "High-pressure stamping of steel sheets"
  wait_time: 3.2d
  process_time: 40s
  defect_rate: 2.5
}

process welding {
  stage_id: 2
  name: "Spot Welding Assembly"
  owner: "Welding Department"
  description: "Robotic spot welding of stamped components"
  wait_time: 1.8d
  process_time: 55s
  defect_rate: 1.2
}

process photography {
  stage_id: 3
  name: "Quality Photography"
  owner: "QC Documentation Team"
  description: "Digital photography for quality records"
  wait_time: 1.2d
  process_time: 25s
  defect_rate: 0.5
}

process assembly {
  stage_id: 4
  name: "Final Door Assembly"
  owner: "Assembly Line Team"
  description: "Installation of hinges, handles, weather stripping"
  wait_time: 2.5d
  process_time: 85s
  defect_rate: 3.1
}

flow from stamping to welding {
  wait_time: 0.5d
}

flow from stamping to photography {
  wait_time: 0.3d
}

flow from welding to assembly {
  wait_time: 1.8d
}

flow from photography to assembly {
  wait_time: 2.1d
}</textarea>
                <button class="parse-button" onclick="parseAndVisualize()">Parse & Visualize</button>
                <input type="file" id="fileInput" accept=".vsm" style="display: none;">
            </div>
            <div class="pane-splitter" id="paneSplitter"></div>
            <div class="visualization-panel">
                <div class="canvas-container">
                    <svg id="vsmCanvas" width="900" height="700"></svg>
                </div>
            </div>
        </div>

        <div class="totals-strip">
            <div class="total-item">
                <div class="total-label">Total Lead Time</div>
                <div class="total-value" id="totalLeadTime">-</div>
            </div>
            <div class="total-item">
                <div class="total-label">Total Wait Time</div>
                <div class="total-value" id="totalWaitTime">-</div>
            </div>
            <div class="total-item">
                <div class="total-label">Total Process Time</div>
                <div class="total-value" id="totalProcessTime">-</div>
            </div>
            <div class="total-item">
                <div class="total-label">Critical Path</div>
                <div class="critical-path" id="criticalPath">-</div>
            </div>
        </div>
    </div>

    <script type="module">
        import VSMParser from './js/VSMParser.js';
        import VSMVisualizer from './js/VSMVisualizer.js';

        const parser = new VSMParser();
        let visualizer;

        // Filename state management
        let currentFilename = 'Untitled.vsm';
        let isModified = false;

        function updateFilenameDisplay() {
            const filenameElement = document.querySelector('.filename-text');
            if (filenameElement) {
                filenameElement.textContent = currentFilename;
                if (isModified) {
                    filenameElement.classList.add('modified');
                } else {
                    filenameElement.classList.remove('modified');
                }
            }
        }

        function setFilename(name) {
            currentFilename = name;
            isModified = false;
            updateFilenameDisplay();
            // Store in localStorage for persistence
            localStorage.setItem('vsmCurrentFilename', currentFilename);
        }

        function markAsModified() {
            isModified = true;
            updateFilenameDisplay();
        }

        // Load saved filename on initialization
        function loadSavedFilename() {
            const savedFilename = localStorage.getItem('vsmCurrentFilename');
            if (savedFilename) {
                currentFilename = savedFilename;
            }
            updateFilenameDisplay();
        }

        function clearVSM() {
            const processId = `process_${Date.now()}`;

            // Create default DSL with one process
            const defaultDSL = `process ${processId} {
  stage_id: 1
  name: "New Process"
  owner: ""
  description: "New process description"
  wait_time: 0d
  process_time: 0s
  defect_rate: 0
}`;

            // Set the DSL editor
            document.getElementById('dslEditor').value = defaultDSL;

            // Create the default process structure
            const defaultProcess = {
                attributes: {
                    stage_id: 1,
                    name: "New Process",
                    owner: "",
                    description: "New process description",
                    wait_time: "0d",
                    process_time: "0s",
                    defect_rate: "0"
                }
            };

            // Reset the visualizer data with the default process
            visualizer.currentProcesses = { [processId]: defaultProcess };
            visualizer.currentFlows = [];
            visualizer.currentInfoFlows = [];

            // Position the process in the center
            const centerX = visualizer.width / 2 - visualizer.processWidth / 2;
            const centerY = visualizer.height / 2 - visualizer.processHeight / 2;
            visualizer.positions = { [processId]: { x: centerX, y: centerY } };

            // Visualize with the default process
            visualizer.visualize({
                processes: visualizer.currentProcesses,
                flows: [],
                infoFlows: [],
                positions: visualizer.positions
            });

            // Reset filename
            setFilename('Untitled.vsm');
            // Clear localStorage filename
            localStorage.removeItem('vsmCurrentFilename');
        }

        async function initializeVSM() {
            visualizer = new VSMVisualizer(document.getElementById('vsmCanvas'));
            
            // Try to load saved state first
            if (!visualizer.loadState()) {
                // If no saved state, load initial DSL
                const initialData = parser.loadInitialDSL();
                visualizer.visualize(initialData);
            }

            // Setup editor panel toggle
            const editorPanel = document.querySelector('.editor-panel');
            const toggleButton = document.querySelector('.editor-toggle');
            
            if (toggleButton) {
                toggleButton.addEventListener('click', () => {
                    editorPanel.classList.toggle('collapsed');
                    toggleButton.textContent = editorPanel.classList.contains('collapsed') ? '⟩' : '⟨';
                });
            }

            // Add button click handlers
            document.querySelector('[data-action="clear"]').addEventListener('click', clearVSM);
            document.querySelector('[data-action="save-file"]').addEventListener('click', saveVSMToFile);
            document.querySelector('[data-action="load-file"]').addEventListener('click', loadVSMFromFile);

            // Track editor modifications
            document.getElementById('dslEditor').addEventListener('input', markAsModified);

            // Load saved filename on init
            loadSavedFilename();
        }

        function parseAndVisualize() {
            const dslText = document.getElementById('dslEditor').value;
            const parsedData = parser.parse(dslText);
            
            // No time validation needed since CT is calculated as PT + WT
            
            // If validation passes, update visualization
            visualizer.visualize(parsedData);
        }

        function saveVSM() {
            if (visualizer) {
                visualizer.saveState();
            }
        }

        function addNewProcess() {
            const processId = `process_${Date.now()}`;
            const newProcess = {
                attributes: {
                    stage_id: 1,
                    name: "New Process",
                    owner: "",
                    description: "New process description",
                    wait_time: "0d",
                    process_time: "0s",
                    defect_rate: "0"
                }
            };

            // Add to current processes
            visualizer.currentProcesses[processId] = newProcess;

            // Calculate position for new process
            const centerX = visualizer.width / 2 - visualizer.processWidth / 2;
            const centerY = visualizer.height / 2 - visualizer.processHeight / 2;
            visualizer.positions[processId] = { x: centerX, y: centerY };

            // Update the DSL text
            const dslEditor = document.getElementById('dslEditor');
            const processBlock = `\nprocess ${processId} {
  stage_id: 1
  name: "New Process"
  owner: ""
  description: "New process description"
  wait_time: 0d
  process_time: 0s
  defect_rate: 0
}\n`;
            
            dslEditor.value += processBlock;

            // Redraw the visualization
            visualizer.visualize({
                processes: visualizer.currentProcesses,
                flows: visualizer.currentFlows,
                infoFlows: visualizer.currentInfoFlows,
                positions: visualizer.positions
            });
        }

        function saveVSMToFile() {
            try {
                // Get current state from visualizer
                const currentState = {
                    processes: visualizer.currentProcesses,
                    flows: visualizer.currentFlows,
                    infoFlows: visualizer.currentInfoFlows,
                    positions: visualizer.positions
                };

                // Serialize to DSL format
                const dslContent = parser.serialize(currentState);

                // Create blob and download
                const blob = new Blob([dslContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                // Create temporary download link
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = currentFilename;

                // Trigger download
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

                // Clean up
                URL.revokeObjectURL(url);

                // Mark as saved
                isModified = false;
                updateFilenameDisplay();

                console.log('VSM saved to file:', currentFilename);
            } catch (error) {
                console.error('Error saving VSM file:', error);
                alert('Error saving file: ' + error.message);
            }
        }

        function loadVSMFromFile() {
            const fileInput = document.getElementById('fileInput');

            // Set up the file input handler
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file extension
                if (!file.name.endsWith('.vsm')) {
                    alert('Invalid file type. Please select a .vsm file.');
                    fileInput.value = '';
                    return;
                }

                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const dslContent = e.target.result;

                        // Validate DSL content
                        const parsedData = parser.parse(dslContent);

                        // Basic validation: check if we have processes
                        if (!parsedData.processes || Object.keys(parsedData.processes).length === 0) {
                            throw new Error('Invalid VSM file: No processes found');
                        }

                        // Load into editor
                        document.getElementById('dslEditor').value = dslContent;

                        // Visualize the loaded data
                        visualizer.visualize(parsedData);

                        // Update filename
                        setFilename(file.name);

                        // Save to localStorage for auto-recovery
                        visualizer.saveState();

                        console.log('VSM loaded from file:', file.name);
                    } catch (error) {
                        console.error('Error loading VSM file:', error);
                        alert('Error loading file: ' + error.message + '\n\nPlease check that the file is a valid VSM DSL file.');
                    } finally {
                        // Reset file input
                        fileInput.value = '';
                    }
                };

                reader.onerror = function() {
                    alert('Error reading file. Please try again.');
                    fileInput.value = '';
                };

                reader.readAsText(file);
            };

            // Trigger file selection dialog
            fileInput.click();
        }

        // Make functions globally available
        window.parser = parser;
        window.saveVSM = saveVSM;
        window.parseAndVisualize = parseAndVisualize;
        window.addNewProcess = addNewProcess;
        window.saveVSMToFile = saveVSMToFile;
        window.loadVSMFromFile = loadVSMFromFile;

        // Initialize pane splitter
        function initializePaneSplitter() {
            const splitter = document.getElementById('paneSplitter');
            const editorPanel = document.querySelector('.editor-panel');
            const mainContent = document.querySelector('.main-content');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            splitter.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = editorPanel.offsetWidth;
                splitter.classList.add('active');
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'col-resize';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const deltaX = e.clientX - startX;
                const newWidth = Math.max(200, Math.min(startWidth + deltaX, mainContent.offsetWidth * 0.8));
                editorPanel.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    splitter.classList.remove('active');
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                }
            });
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeVSM();
                initializePaneSplitter();
            });
        } else {
            initializeVSM();
            initializePaneSplitter();
        }
    </script>
</body>
</html>